<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings - FitNet</title>
    <link rel="stylesheet" href="static/css/dashboard.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="static/images/FitNet Logo.png" alt="FitNet Logo">
            </div>
            <nav class="navigation">
                <ul>
                    <li><a href="/dashboard">Dashboard</a></li>
                    <li><a href="/log-workout">Log Workout</a></li>
                    <li><a href="/progress">Progress</a></li>
                    <li><a href="/profile" class="active">Profile</a></li>
                </ul>
            </nav>
            <div class="actions">
                <div class="user-profile">
                  <a href="/profile" class="profile-link active-profile">
                    <div class="profile-avatar">
                      {% if user_data and user_data.profile_image %}
                        <img src="{{ url_for('uploaded_file', filename=user_data.profile_image) }}" alt="Profile" class="avatar-image">
                      {% else %}
                        <i class="fas fa-user"></i>
                      {% endif %}
                    </div>
                    <span class="username">{{ (user_data.first_name + ' ' + user_data.surname) if user_data and user_data.first_name and user_data.surname else session.get('name', 'Guest') if session.get('name') and session.get('name') != 'User' else 'Guest' }}</span>
                  </a>
                </div>
                <button class="logout logout-light-red" onclick="window.location.href='/logout'">Log Out</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="profile-header">
            <h2>Profile Settings</h2>
            <p>Manage your account and fitness preferences</p>
        </div>

        <div class="profile-tabs">
            <button class="tab-btn active" data-tab="personal" onclick="showTab('personal')">Personal Info</button>
            <button class="tab-btn" data-tab="goals" onclick="showTab('goals')">Fitness Goals</button>
        </div>

        <div class="profile-content">
            <!-- Personal Information Tab -->
            <div id="personal-tab" class="profile-tab active">
                <div class="profile-section">
                    <!-- Profile Photo Section -->
                    <div class="profile-photo-section card">
                        <h3>Profile Photo</h3>
                        <div class="photo-container">
                            <div class="profile-photo">
                                {% if user_data.profile_image %}
                                    <img src="{{ url_for('uploaded_file', filename=user_data.profile_image) }}" alt="Profile Photo" id="profileImage">
                                {% else %}
                                    <img src="static/images/default-avatar.jpg" alt="Profile Photo" id="profileImage">
                                {% endif %}
                            </div>
                            
                            <!-- Photo Upload Form -->
                            <form method="POST" enctype="multipart/form-data" class="upload-form">
                                <input type="hidden" name="form_type" value="upload_photo">
                                <input type="file" id="photoInput" name="profile_photo" accept=".jpg,.jpeg,.png,.gif" style="display: none;" onchange="previewImage(this)">
                                <button type="button" class="upload-btn" onclick="document.getElementById('photoInput').click()">
                                    Choose Photo
                                </button>
                                <button type="submit" class="save-photo-btn" id="savePhotoBtn" style="display: none;">
                                    Save Photo
                                </button>
                            </form>
                            
                            <p class="photo-note">JPG, PNG or GIF. Max size 5MB.</p>
                            
                            <!-- Upload Progress -->
                            <div id="uploadProgress" class="upload-progress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                                <p>Uploading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information Section -->
                    <div class="personal-info-section card">
                        <h3>Personal Information</h3>
                        <p>Update your personal details</p>
                        
                        <form method="POST" class="profile-form">
                            <input type="hidden" name="form_type" value="personal_info">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="first_name">First Name</label>
                                    <input type="text" id="first_name" name="first_name" 
                                           value="{{ user_data.first_name if user_data else '' }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="surname">Last Name</label>
                                    <input type="text" id="surname" name="surname" 
                                           value="{{ user_data.surname if user_data else '' }}" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" name="email" 
                                           value="{{ user_data.email if user_data else '' }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="age">Age</label>
                                    <input type="number" id="age" name="age" 
                                           value="{{ user_data.age if user_data else '' }}" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="height">Height (cm)</label>
                                    <input type="number" id="height" name="height" 
                                           value="{{ user_data.height_cm if user_data else '' }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="weight">Current Weight (kg)</label>
                                    <input type="number" id="weight" name="weight" step="0.1"
                                           value="{{ user_data.weight_kg if user_data else '' }}" required>
                                </div>
                            </div>

                            <button type="submit" class="save-changes-btn">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Fitness Goals Tab -->
            <div id="goals-tab" class="profile-tab">
                <div class="profile-section">
                    <!-- Add New Goal Section -->
                    <div class="add-goal-section card">
                        <h3>Add New Goal</h3>
                        <p>Set a new fitness goal to track your progress</p>
                        
                        <form method="POST" class="goal-form">
                            <input type="hidden" name="form_type" value="add_goal">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="goal_type">Goal Type</label>
                                    <select id="goal_type" name="goal_type" required>
                                        <option value="">Select goal type</option>
                                        <option value="weight_loss">Weight Loss</option>
                                        <option value="muscle_gain">Muscle Gain</option>
                                        <option value="strength">Strength Training</option>
                                        <option value="endurance">Endurance</option>
                                        <option value="custom">Custom Goal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="goal_direction">Goal Direction</label>
                                    <select id="goal_direction" name="goal_direction" required>
                                        <option value="up">Higher is Better (gain weight, lift more, run further)</option>
                                        <option value="down">Lower is Better (lose weight, faster time, lower %)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="goal_name">Goal Name</label>
                                    <input type="text" id="goal_name" name="goal_name" 
                                           placeholder="e.g., Lose 10kg, Bench 100kg, Run 5km in 25min" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="target_value">Target Value</label>
                                    <input type="number" id="target_value" name="target_value" 
                                           step="0.1" placeholder="e.g., 70 (for 70kg target weight)">
                                </div>
                                <div class="form-group">
                                    <label for="current_value">Current Value</label>
                                    <input type="number" id="current_value" name="current_value" 
                                           step="0.1" placeholder="e.g., 80 (current weight)" value="0">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="target_date">Target Date (Optional)</label>
                                <input type="date" id="target_date" name="target_date">
                            </div>

                            <button type="submit" class="add-goal-btn">Add Goal</button>
                        </form>
                    </div>

                    <!-- Current Goals Section -->
                    <div class="current-goals-section card">
                        <h3>Your Goals</h3>
                        <p>Track your progress towards your fitness goals</p>
                        
                        {% if goals %}
                            <div class="goals-list">
                                {% for goal in goals %}
                                <div class="goal-item {% if goal.is_completed %}completed{% endif %}">
                                    <div class="goal-header">
                                        <div class="goal-info">
                                            <h4>{{ goal.goal_name }}</h4>
                                            <span class="goal-type-badge {{ goal.goal_type }}">{{ goal.goal_type.replace('_', ' ').title() }}</span>
                                        </div>
                                        <div class="goal-actions">
                                            <button class="edit-goal-btn" onclick="toggleEditGoal({{ goal.goal_id }})">✏️</button>
                                            <form method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this goal?')">
                                                <input type="hidden" name="form_type" value="delete_goal">
                                                <input type="hidden" name="goal_id" value="{{ goal.goal_id }}">
                                                <button type="submit" class="delete-goal-btn">🗑️</button>
                                            </form>
                                        </div>
                                    </div>

                                    <div class="goal-progress">
                                        {% if goal.target_value %}
                                            <div class="progress-info">
                                                <span>{{ goal.current_value }} / {{ goal.target_value }}</span>
                                                <span>{{ goal | goal_display_text }}</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress" style="width: {{ goal | goal_progress }}%;"></div>
                                            </div>
                                        {% endif %}
                                        
                                        {% if goal.target_date %}
                                            <p class="target-date">Target Date: {{ goal.target_date }}</p>
                                        {% endif %}
                                    </div>

                                    <!-- Edit Goal Form (Hidden by default) -->
                                    <div id="edit-goal-{{ goal.goal_id }}" class="edit-goal-form" style="display: none;">
                                        <form method="POST">
                                            <input type="hidden" name="form_type" value="update_goal">
                                            <input type="hidden" name="goal_id" value="{{ goal.goal_id }}">
                                            
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label>Update Current Value</label>
                                                    <input type="number" name="current_value" step="0.1" 
                                                           value="{{ goal.current_value }}" required>
                                                </div>
                                                <div class="form-group">
                                                    <label>
                                                        <input type="checkbox" name="is_completed" 
                                                               {% if goal.is_completed %}checked{% endif %}>
                                                        Mark as Completed
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="goal-edit-actions">
                                                <button type="submit" class="update-goal-btn">Update</button>
                                                <button type="button" class="cancel-edit-btn" onclick="toggleEditGoal({{ goal.goal_id }})">Cancel</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="no-goals">
                                <p>No goals set yet. Add your first fitness goal above!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="profile-tab">
                <div class="profile-section">
                    <div class="settings-section card">
                        <h3>Settings</h3>
                        <p>App preferences and account settings</p>
                        <!-- Add settings content here later -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.profile-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Handle URL fragments to navigate directly to specific tabs
        function handleUrlFragment() {
            const hash = window.location.hash;
            if (hash === '#goals-tab') {
                showTab('goals');
            } else if (hash === '#settings-tab') {
                showTab('settings');
            } else if (hash === '#personal-tab') {
                showTab('personal');
            }
            // Clear the hash from URL after processing
            if (hash && hash.includes('-tab')) {
                history.replaceState(null, null, window.location.pathname);
            }
        }

        // Check for URL fragment when page loads
        document.addEventListener('DOMContentLoaded', function() {
            handleUrlFragment();
            
            // Handle form submission with progress indication
            const uploadForms = document.querySelectorAll('form[enctype="multipart/form-data"]');
            
            uploadForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const fileInput = form.querySelector('input[type="file"]');
                    if (fileInput && fileInput.files.length > 0) {
                        // Show progress indicator
                        const progressDiv = document.getElementById('uploadProgress');
                        if (progressDiv) {
                            progressDiv.style.display = 'block';
                        }
                        
                        // Disable submit button to prevent double submission
                        const submitBtn = form.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Uploading...';
                        }
                    }
                });
            });
        });

        // Handle browser back/forward navigation
        window.addEventListener('popstate', function() {
            handleUrlFragment();
        });

        function toggleEditGoal(goalId) {
            const editForm = document.getElementById(`edit-goal-${goalId}`);
            if (editForm.style.display === 'none') {
                editForm.style.display = 'block';
            } else {
                editForm.style.display = 'none';
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (5MB = 5 * 1024 * 1024 bytes)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    input.value = '';
                    return;
                }
                
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPG, PNG, or GIF)');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    document.getElementById('profileImage').src = e.target.result;
                    document.getElementById('savePhotoBtn').style.display = 'inline-block';
                }
                
                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>